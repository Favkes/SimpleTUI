name: Render Mermaid Diagrams

on:
  push:
    branches:
      - '**'
  pull_request:

permissions:
  contents: write   # ← REQUIRED for generated files

jobs:
  render-diagrams:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Render .mmd → .svg
        run: |
          mkdir -p docs/assets/diagrams
          for f in docs/diagrams/*.mmd; do
            out="docs/assets/diagrams/$(basename "$f" .mmd).svg"
            echo "Rendering $f → $out"
            mmdc -i "$f" -o "$out" --puppeteerConfigFile .puppeteer.json
          done

      - name: Commit rendered diagrams
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          git add docs/assets/diagrams/*.svg || true
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Render Mermaid diagrams"
            git push
          fi