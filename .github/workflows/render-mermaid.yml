name: Render Mermaid Diagrams

on:
  push:
    branches:
      - '**'
  pull_request:

permissions:
  contents: write   # ← REQUIRED for generated files

jobs:
  render-diagrams:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Render .mmd → .svg
        run: |
          mkdir -p docs/assets/diagrams
          for f in docs/diagrams/*.mmd; do
            out="docs/assets/diagrams/$(basename "$f" .mmd).svg"
            echo "Rendering $f → $out"
            mmdc -i "$f" -o "$out" --puppeteerConfigFile .puppeteer.json --theme dark
          done

      - name: Push rendered diagrams to docs-assets branch
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          git clone --branch docs-assets --single-branch https://github.com/${GITHUB_REPOSITORY}.git docs-assets
          rm -rf docs-assets/docs/assets/diagrams/*
          
          cp docs/assets/diagrams/* docs-assets/docs/assets/diagrams

          cd docs-assets
          git add .
          git commit -m "Update rendered diagrams" || echo "No changes to commit"
          git push